<x-portal-layout>
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
        {{-- „Éò„ÉÉ„ÉÄ„Éº --}}
        <div class="bg-slate-100 border-b-2 border-gray-200 p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        üìä {{ $project->name }} - WBS/„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà
                    </h1>
                    <p class="text-gray-600 mt-1">{{ $project->description }}</p>
                </div>
                <div class="flex gap-3">
                    {{-- Ë°®Á§∫Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ --}}
                    <div class="bg-white rounded-lg border border-gray-300 p-1">
                        <button id="wbs-view-btn" class="px-4 py-2 rounded-md bg-blue-500 text-white transition">
                            üìã WBSË°®Á§∫
                        </button>
                        <button id="gantt-view-btn" class="px-4 py-2 rounded-md hover:bg-gray-100 transition">
                            üìà „Ç¨„É≥„ÉàË°®Á§∫
                        </button>
                    </div>
                    {{-- Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê„Éú„Çø„É≥ --}}
                    <button id="add-task-btn"
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition shadow-md">
                        ‚ûï Êñ∞Ë¶è„Çø„Çπ„ÇØ
                    </button>
                </div>
            </div>
        </div>

        <div class="p-6">
            {{-- „Éï„É©„ÉÉ„Ç∑„É•„É°„ÉÉ„Çª„Éº„Ç∏ --}}
            <x-flash-message />

            {{-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÄ≤Êçó„Çµ„Éû„É™„Éº --}}
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-2xl font-bold text-blue-600" id="total-tasks">
                        {{ $parentTasks->sum(function ($task) {return 1 + $task->children->count();}) }}</div>
                    <div class="text-sm text-blue-600">Á∑è„Çø„Çπ„ÇØÊï∞</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-2xl font-bold text-green-600" id="completed-tasks">
                        {{ $parentTasks->sum(function ($task) {
                            return ($task->status === 'done' ? 1 : 0) + $task->children->where('status', 'done')->count();
                        }) }}
                    </div>
                    <div class="text-sm text-green-600">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <div class="text-2xl font-bold text-yellow-600" id="in-progress-tasks">
                        {{ $parentTasks->sum(function ($task) {
                            return ($task->status === 'in_progress' ? 1 : 0) + $task->children->where('status', 'in_progress')->count();
                        }) }}
                    </div>
                    <div class="text-sm text-yellow-600">ÈÄ≤Ë°å‰∏≠„Çø„Çπ„ÇØ</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <div class="text-2xl font-bold text-purple-600" id="progress-percentage">
                        {{ $parentTasks->sum(function ($task) {
                            return 1 + $task->children->count();
                        }) > 0
                            ? round(
                                ($parentTasks->sum(function ($task) {
                                    return ($task->status === 'done' ? 1 : 0) + $task->children->where('status', 'done')->count();
                                }) /
                                    $parentTasks->sum(function ($task) {
                                        return 1 + $task->children->count();
                                    })) *
                                    100,
                                1,
                            )
                            : 0 }}%
                    </div>
                    <div class="text-sm text-purple-600">ÂÖ®‰ΩìÈÄ≤Êçó</div>
                </div>
            </div>

            {{-- WBSË°®Á§∫„Ç®„É™„Ç¢ --}}
            <div id="wbs-container" class="bg-white">
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">WBS</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">„Çø„Çπ„ÇØÂêç</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">ÊãÖÂΩìËÄÖ</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">ÈñãÂßã‰∫àÂÆö</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">ÁµÇ‰∫Ü‰∫àÂÆö</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">ÈñãÂßãÊó•</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">ÁµÇ‰∫ÜÊó•</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">ÈÄ≤Êçó</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">Â∑•Êï∞</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-bold">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-tbody">
                            @foreach ($parentTasks as $parentTask)
                                {{-- Ë¶™„Çø„Çπ„ÇØË°å --}}
                                <tr class="hover:bg-gray-50 parent-task" data-task-id="{{ $parentTask->id }}">
                                    <td class="border border-gray-300 px-4 py-3 font-bold">{{ $parentTask->wbs_number }}
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        <div class="flex items-center">
                                            @if ($parentTask->children->count() > 0)
                                                <button class="expand-btn mr-2 text-gray-500 hover:text-gray-700"
                                                    data-task-id="{{ $parentTask->id }}">
                                                    <span class="expand-icon">‚ñ∂</span>
                                                </button>
                                            @endif
                                            <span class="font-bold text-blue-800">{{ $parentTask->title }}</span>
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        {{ $parentTask->user ? $parentTask->user->name : 'Êú™Ââ≤„ÇäÂΩì„Å¶' }}
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        <span
                                            class="px-2 py-1 rounded-full text-xs font-medium {{ $parentTask->status_class }}">
                                            {{ $parentTask->status_label }}
                                        </span>
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        {{ $parentTask->planned_start_date?->format('Y/m/d') ?? '-' }}
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        {{ $parentTask->planned_end_date?->format('Y/m/d') ?? '-' }}
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        {{ $parentTask->actual_start_date?->format('Y/m/d') ?? '-' }}
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        {{ $parentTask->actual_end_date?->format('Y/m/d') ?? '-' }}
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full"
                                                style="width: {{ $parentTask->progress_percentage }}%"></div>
                                        </div>
                                        <span
                                            class="text-xs text-gray-600">{{ $parentTask->progress_percentage }}%</span>
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3 text-sm">
                                        <div>‰∫àÂÆö: {{ $parentTask->planned_effort ?? '-' }}h</div>
                                        <div>ÂÆüÁ∏æ: {{ $parentTask->actual_effort ?? '-' }}h</div>
                                    </td>
                                    <td class="border border-gray-300 px-4 py-3">
                                        <div class="flex gap-1">
                                            <button
                                                class="edit-task-btn px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded"
                                                data-task-id="{{ $parentTask->id }}">
                                                Á∑®ÈõÜ
                                            </button>
                                            <button
                                                class="add-child-btn px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded"
                                                data-parent-id="{{ $parentTask->id }}">
                                                Â≠ê„Çø„Çπ„ÇØ„ÇíËøΩÂä†
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                {{-- Â≠ê„Çø„Çπ„ÇØË°åÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ --}}
                                @foreach ($parentTask->children as $childTask)
                                    <tr class="hover:bg-gray-50 child-task hidden"
                                        data-parent-id="{{ $parentTask->id }}" data-task-id="{{ $childTask->id }}">
                                        <td class="border border-gray-300 px-4 py-3 pl-8">{{ $childTask->wbs_number }}
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3 pl-8">
                                            <span class="text-gray-700">{{ $childTask->title }}</span>
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            {{ $childTask->user ? $childTask->user->name : 'Êú™Ââ≤„ÇäÂΩì„Å¶' }}
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            <span
                                                class="px-2 py-1 rounded-full text-xs font-medium {{ $childTask->status_class }}">
                                                {{ $childTask->status_label }}
                                            </span>
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            {{ $childTask->planned_start_date?->format('Y/m/d') ?? '-' }}
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            {{ $childTask->planned_end_date?->format('Y/m/d') ?? '-' }}
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            {{ $childTask->actual_start_date?->format('Y/m/d') ?? '-' }}
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            {{ $childTask->actual_end_date?->format('Y/m/d') ?? '-' }}
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-green-600 h-2 rounded-full"
                                                    style="width: {{ $childTask->progress_percentage }}%"></div>
                                            </div>
                                            <span
                                                class="text-xs text-gray-600">{{ $childTask->progress_percentage }}%</span>
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3 text-sm">
                                            <div>‰∫àÂÆö: {{ $childTask->planned_effort ?? '-' }}h</div>
                                            <div>ÂÆüÁ∏æ: {{ $childTask->actual_effort ?? '-' }}h</div>
                                        </td>
                                        <td class="border border-gray-300 px-4 py-3">
                                            <div class="flex gap-1">
                                                <button
                                                    class="edit-task-btn px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded"
                                                    data-task-id="{{ $childTask->id }}">
                                                    Á∑®ÈõÜ
                                                </button>
                                                <button
                                                    class="delete-task-btn px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded"
                                                    data-task-id="{{ $childTask->id }}">
                                                    ÂâäÈô§
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                @endforeach
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>

            {{-- „Ç¨„É≥„Éà„ÉÅ„É£„Éº„ÉàË°®Á§∫„Ç®„É™„Ç¢ÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ --}}
            <div id="gantt-container" class="bg-white hidden">
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold">„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà</h3>
                    <div class="flex gap-2">
                        <button id="gantt-zoom-out"
                            class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-sm rounded">
                            Á∏ÆÂ∞è
                        </button>
                        <button id="gantt-zoom-in"
                            class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-sm rounded">
                            Êã°Â§ß
                        </button>
                    </div>
                </div>
                <div id="gantt-chart" class="overflow-x-auto border border-gray-300 rounded-lg">
                    {{-- „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„ÅØJavaScript„ÅßÂãïÁöÑÁîüÊàê --}}
                </div>
            </div>
        </div>
    </div>

    {{-- „Çø„Çπ„ÇØ‰ΩúÊàê„ÉªÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ --}}
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-90vh overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="modal-title" class="text-2xl font-bold">Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê</h2>
                        <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                    </div>

                    <form id="task-form">
                        <input type="hidden" id="task-id" name="task_id">
                        <input type="hidden" id="parent-id" name="parent_id">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {{-- „Çø„Çπ„ÇØÂêç --}}
                            <div class="md:col-span-2">
                                <label for="title" class="block text-sm font-bold text-gray-700 mb-2">„Çø„Çπ„ÇØÂêç
                                    *</label>
                                <input type="text" id="title" name="title" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            {{-- Ë™¨Êòé --}}
                            <div class="md:col-span-2">
                                <label for="description" class="block text-sm font-bold text-gray-700 mb-2">Ë™¨Êòé</label>
                                <textarea id="description" name="description" rows="3"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>

                            {{-- ÊãÖÂΩìËÄÖ --}}
                            <div>
                                <label for="user_id" class="block text-sm font-bold text-gray-700 mb-2">ÊãÖÂΩìËÄÖ</label>
                                <select id="user_id" name="user_id"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Êú™Ââ≤„ÇäÂΩì„Å¶</option>
                                    @foreach ($users as $user)
                                        <option value="{{ $user->id }}">{{ $user->name }}</option>
                                    @endforeach
                                </select>
                            </div>

                            {{-- „Çπ„ÉÜ„Éº„Çø„Çπ --}}
                            <div>
                                <label for="status" class="block text-sm font-bold text-gray-700 mb-2">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <select id="status" name="status"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="todo">Êú™ÁùÄÊâã</option>
                                    <option value="in_progress">ÈÄ≤Ë°å‰∏≠</option>
                                    <option value="done">ÂÆå‰∫Ü</option>
                                </select>
                            </div>

                            {{-- ÈñãÂßã‰∫àÂÆöÊó• --}}
                            <div>
                                <label for="planned_start_date"
                                    class="block text-sm font-bold text-gray-700 mb-2">ÈñãÂßã‰∫àÂÆöÊó•</label>
                                <input type="date" id="planned_start_date" name="planned_start_date"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            {{-- ÁµÇ‰∫Ü‰∫àÂÆöÊó• --}}
                            <div>
                                <label for="planned_end_date"
                                    class="block text-sm font-bold text-gray-700 mb-2">ÁµÇ‰∫Ü‰∫àÂÆöÊó•</label>
                                <input type="date" id="planned_end_date" name="planned_end_date"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>


                            {{-- ‰∫àÂÆöÂ∑•Êï∞ --}}
                            <div>
                                <label for="planned_effort"
                                    class="block text-sm font-bold text-gray-700 mb-2">‰∫àÂÆöÂ∑•Êï∞ÔºàÊôÇÈñìÔºâ</label>
                                <input type="number" id="planned_effort" name="planned_effort" step="0.5"
                                    min="0"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            {{-- ÂÆüÈöõÂ∑•Êï∞ÔºàÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ --}}
                            <div id="actual-effort-container" class="hidden">
                                <label for="actual_effort"
                                    class="block text-sm font-bold text-gray-700 mb-2">ÂÆüÈöõÂ∑•Êï∞ÔºàÊôÇÈñìÔºâ</label>
                                <input type="number" id="actual_effort" name="actual_effort" step="0.5"
                                    min="0"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            {{-- ÈñãÂßãÊó•ÔºàÂÆüÁ∏æÔºâ --}}
                            <div id="actual-start-date-container" class="hidden">
                                <label for="actual_start_date"
                                    class="block text-sm font-bold text-gray-700 mb-2">ÈñãÂßãÊó•</label>
                                <input type="date" id="actual_start_date" name="actual_start_date"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            {{-- ÁµÇ‰∫ÜÊó•ÔºàÂÆüÁ∏æÔºâ --}}
                            <div id="actual-end-date-container" class="hidden">
                                <label for="actual_end_date"
                                    class="block text-sm font-bold text-gray-700 mb-2">ÁµÇ‰∫ÜÊó•</label>
                                <input type="date" id="actual_end_date" name="actual_end_date"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" id="cancel-btn"
                                class="px-6 py-3 bg-gray-300 hover:bg-gray-400 rounded-lg font-bold">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                            <button type="submit" id="save-btn"
                                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @push('scripts')
        <script>
            (function() { // --- [ËøΩÂä†] Âç≥ÊôÇÂÆüË°åÈñ¢Êï∞„ÅßÂÖ®‰Ωì„ÇíÂõ≤„ÇÄ ---
                // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
                const projectId = {{ $project->id }};
                let ganttInstance = null; // „Ç¨„É≥„Éà„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰øùÊåÅ„Åô„ÇãÂ§âÊï∞

                // „Éö„Éº„Ç∏„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü„Åó„Åü„Çâ„ÄÅÂÖ®„Å¶„ÅÆÂá¶ÁêÜ„ÇíÈñãÂßã
                document.addEventListener('DOMContentLoaded', function() {
                    // gantt„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅåÂ≠òÂú®„Åó„Å™„Åã„Å£„Åü„Çâ„ÄÅÂá¶ÁêÜ„Çí‰∏≠Êñ≠
                    if (typeof gantt === 'undefined') {
                        console.error('dhtmlx-gantt is not loaded!');
                        return;
                    }
                    initializeEventListeners();
                });

                // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÂàùÊúüÂåñ ---
                function initializeEventListeners() {
                    // Ë°®Á§∫Âàá„ÇäÊõø„Åà
                    document.getElementById('wbs-view-btn').addEventListener('click', () => switchView('wbs'));
                    document.getElementById('gantt-view-btn').addEventListener('click', () => switchView('gantt'));

                    // Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê
                    document.getElementById('add-task-btn').addEventListener('click', () => openTaskModal());

                    // „É¢„Éº„ÉÄ„É´Êìç‰Ωú
                    document.getElementById('close-modal').addEventListener('click', closeTaskModal);
                    document.getElementById('cancel-btn').addEventListener('click', closeTaskModal);
                    document.getElementById('task-form').addEventListener('submit', handleTaskSubmit);

                    // „Ç§„Éô„É≥„ÉàÂßî‰ªª (WBS„ÉÜ„Éº„Éñ„É´)
                    const tbody = document.getElementById('tasks-tbody');
                    tbody.addEventListener('click', function(e) {
                        const editBtn = e.target.closest('.edit-task-btn');
                        if (editBtn) {
                            editTask(editBtn.dataset.taskId);
                            return;
                        }
                        const addChildBtn = e.target.closest('.add-child-btn');
                        if (addChildBtn) {
                            openTaskModal(null, addChildBtn.dataset.parentId);
                            return;
                        }
                        const deleteBtn = e.target.closest('.delete-task-btn');
                        if (deleteBtn) {
                            deleteTask(deleteBtn.dataset.taskId);
                            return;
                        }
                        const expandBtn = e.target.closest('.expand-btn');
                        if (expandBtn) {
                            toggleTaskExpansion(expandBtn);
                            return;
                        }
                    });

                    // „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„ÅÆ„Ç∫„Éº„É†„Éú„Çø„É≥
                    document.getElementById('gantt-zoom-in').addEventListener('click', () => ganttInstance?.ext.zoom
                    .zoomIn());
                    document.getElementById('gantt-zoom-out').addEventListener('click', () => ganttInstance?.ext.zoom
                        .zoomOut());
                }

                // --- WBS„ÅÆÂ±ïÈñã„ÉªÊäò„Çä„Åü„Åü„Åø ---
                function toggleTaskExpansion(button) {
                    const taskId = button.dataset.taskId;
                    const childRows = document.querySelectorAll(`tr[data-parent-id="${taskId}"]`);
                    const icon = button.querySelector('.expand-icon');
                    const isCollapsed = icon.textContent === '‚ñ∂';

                    childRows.forEach(row => row.classList.toggle('hidden', !isCollapsed));
                    icon.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
                }

                // --- Ë°®Á§∫Âàá„ÇäÊõø„Åà ---
                function switchView(view) {
                    const wbsContainer = document.getElementById('wbs-container');
                    const ganttContainer = document.getElementById('gantt-container');
                    const wbsBtn = document.getElementById('wbs-view-btn');
                    const ganttBtn = document.getElementById('gantt-view-btn');

                    if (view === 'wbs') {
                        wbsContainer.classList.remove('hidden');
                        ganttContainer.classList.add('hidden');
                        wbsBtn.classList.add('bg-blue-500', 'text-white');
                        wbsBtn.classList.remove('hover:bg-gray-100');
                        ganttBtn.classList.remove('bg-blue-500', 'text-white');
                        ganttBtn.classList.add('hover:bg-gray-100');
                    } else {
                        wbsContainer.classList.add('hidden');
                        ganttContainer.classList.remove('hidden');
                        ganttBtn.classList.add('bg-blue-500', 'text-white');
                        ganttBtn.classList.remove('hover:bg-gray-100');
                        wbsBtn.classList.remove('bg-blue-500', 'text-white');
                        wbsBtn.classList.add('hover:bg-gray-100');

                        // „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„Åå„Åæ„Å†ÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„ÄÅÊèèÁîª„Åô„Çã
                        if (!ganttInstance) {
                            renderGanttChart();
                        }
                    }
                }

                // --- „É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£„ÅÆÈñ¢Êï∞ ---
                // (openTaskModal, closeTaskModal, fetchTaskData, handleTaskSubmit, editTask, deleteTask „ÅØ„ÄÅ
                //  ÂâçÂõû„ÅÆ‰øÆÊ≠£Áâà„Å®„Åª„ÅºÂêå„Åò„Å™„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØÁúÅÁï•„Åó„Åæ„Åô„ÄÇÂæå„ÅßÂÆåÂÖ®Áâà„ÇíË®òËºâ„Åó„Åæ„Åô)

                // --- „Ç¨„É≥„Éà„ÉÅ„É£„Éº„ÉàÊèèÁîª ---
                async function renderGanttChart() {
                    const container = document.getElementById('gantt-chart');
                    container.innerHTML = '<div class="p-4">Ë™≠„ÅøËæº„Åø‰∏≠...</div>'; // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫

                    // [‰øÆÊ≠£] gantt„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí„É≠„Éº„Ç´„É´Â§âÊï∞„Å®„Åó„Å¶‰ΩúÊàê
                    const gantt = window.gantt;

                    // --- Ë®≠ÂÆö ---
                    gantt.config.xml_date = "%Y-%m-%d";
                    gantt.config.columns = [{
                            name: "wbs",
                            label: "WBS",
                            tree: true,
                            width: 80,
                            resize: true,
                            template: gantt.getWBSCode
                        },
                        {
                            name: "text",
                            label: "„Çø„Çπ„ÇØÂêç",
                            width: '*',
                            min_width: 200,
                            resize: true
                        },
                        {
                            name: "start_date",
                            label: "ÈñãÂßãÊó•",
                            align: "center",
                            width: 100,
                            resize: true
                        },
                        {
                            name: "duration",
                            label: "ÊúüÈñì",
                            align: "center",
                            width: 60,
                            resize: true
                        },
                        {
                            name: "user",
                            label: "ÊãÖÂΩìËÄÖ",
                            align: "center",
                            width: 100,
                            resize: true,
                            template: function(task) {
                                return task.user || '';
                            }
                        },
                        {
                            name: "add",
                            label: "",
                            width: 44
                        }
                    ];
                    gantt.config.scales = [{
                            unit: "month",
                            step: 1,
                            format: "%YÂπ¥ %F"
                        },
                        {
                            unit: "day",
                            step: 1,
                            format: "%j"
                        }
                    ];
                    gantt.i18n.setLocale("jp"); // Êó•Êú¨Ë™ûÂåñ
                    gantt.plugins({
                        zoom: true
                    }); // „Ç∫„Éº„É†„Éó„É©„Ç∞„Ç§„É≥ÊúâÂäπÂåñ

                    gantt.init(container);
                    ganttInstance = gantt; // [ËøΩÂä†] „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰øùÊåÅ

                    // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
                    gantt.attachEvent("onTaskClick", function(id, e) {
                        if (e.target.closest(".gantt_add")) {
                            openTaskModal(null, id);
                            return false;
                        }
                        return true;
                    });

                    // --- „Éá„Éº„ÇøË™≠„ÅøËæº„Åø ---
                    try {
                        const response = await fetch("{{ route('tasks.ganttData', $project) }}");
                        if (!response.ok) throw new Error('Failed to fetch gantt data');
                        const data = await response.json();
                        gantt.parse(data); // `data`„Ç≠„Éº„Åß„É©„ÉÉ„Éó„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÊÉ≥ÂÆö
                    } catch (error) {
                        console.error("Gantt Error:", error);
                        container.innerHTML = '<div class="p-8 text-center text-red-500">„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>';
                    }
                }

                // --- „Åì„Åì„Å´„ÄÅÁúÅÁï•„Åó„Åü„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£„ÅÆÈñ¢Êï∞„Çí„Éö„Éº„Çπ„Éà ---
                function openTaskModal(taskId = null, parentId = null) {
                    /* ... */ }

                function closeTaskModal() {
                    /* ... */ }
                async function fetchTaskData(taskId) {
                    /* ... */ }
                async function handleTaskSubmit(e) {
                    /* ... */ }

                function editTask(taskId) {
                    /* ... */ }
                async function deleteTask(taskId) {
                    /* ... */ }
                // ---------------------------------------------

            })(); // --- [ËøΩÂä†] Âç≥ÊôÇÂÆüË°åÈñ¢Êï∞„ÅÆÁµÇ‰∫Ü ---
        </script>
    @endpush
</x-portal-layout>
